{% extends 'user/basic.html' %}
{% block title %} Search - Pharamacy Management System {% endblock %}
{% load static %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{% static 'user/search.css' %}">
<style type="text/css">
.col-md-3 {
    display: inline-block;
    margin-left: -4px;
}

.col-md-3 img {
    max-width: 200px;
    height: 200px;
}

body .carousel-indicator li {
    background-color: blue;
}

body .carousel-indicators .active {
    background-color: blue;
}

body .carousel-control-prev-icon,
body .carousel-control-next-icon {
    background-color: blue;
}

.carousel-control-prev,
.carousel-control-next {
    top: auto;
    bottom: auto;
    margin-top: 170px;
    margin-left: 150px;
}

body .no-padding {
    padding-left: 0;
    padding-right: 0;
}

.main {
    margin-top: 128px;
    margin-left: 274px;
    margin-right: 100px;
}
</style>
{% endblock %}
{% block body %}
<div class="main">
    <div class="contain">
        <!-- Slideshow starts here -->
        {% for product,range,nSlides in allProds %}
        <h4 class="my-4">Flash Sale on {{product.0.category}} - Recommended Item</h4>
        <div class="row">
            <div class="col carousel slide my-3" id="demo{{forloop.counter}}" data-ride="carousel">
                <ul class="carousel-indicators">
                    <li data-target="#demo{{forloop.counter}}" data-slide-to="0" class="active"></li>
                    {% for i in range %}
                    <li data-target="#demo{{forloop.parentloop.counter}}" data-slide-to="{{i}}"></li>
                    {% endfor %}
                </ul>
                <div class="container carousel-inner no-padding">
                    <div class="carousel-item active">
                        {% for i in product%}
                        <div class="col-md-3 mx-4">
                            <div class="card align-items-center" style="width: 18rem;">
                                <img class="card-img-top" src='/media/{{i.image}}' alt="Card image cap">
                                <div class="card-body" style="color: black">
                                    <h5 class="card-title" id="namepr{{i.product_id}}">{{i.product_name}}</h5>
                                    <p class="card-text">{{i.desc1|slice:"0:23"}}...</p>
                                    <h6>Price: <span id="pricepr{{i.product_id}}">{{i.price}}</span></h6>
                                    <span id="divpr{{i.product_id}}" class="divpr">
                                        <button id="pr{{i.product_id}}" class="btn btn-primary cart">Add to Cart</button>
                                    </span>
                                    <a href="#"><button id="qv{{i.product_id}}" class="btn btn-primary">QuickView</button></a>
                                </div>
                            </div>
                        </div>
                        {% if forloop.counter|divisibleby:3 and forloop.counter > 0 and not forloop.last%}
                    </div>
                    <div class="carousel-item">
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <a href="#demo{{forloop.counter}}" class="carousel-control-prev" data-slide="prev">
                <span class="carousel-control-prev-icon"></span>
            </a>
            <a href="#demo{{forloop.counter}}" class="carousel-control-next" data-slide="next">
                <span class="carousel-control-next-icon"></span>
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
{% block js %}
<script type="text/javascript">
str = "{{msg}}";
if (str !== "success") {
    alert("{{msg}}");
    window.location.href = "/user";
} else {
    // Find out the cart items from localstorage
    if (localStorage.getItem('cat_cart') == null) {
        var cat_cart = {};
    } else {
        cat_cart = JSON.parse(localStorage.getItem('cat_cart'));
        console.log(cat_cart);
        updateCart(cat_cart);
    }

    // If the add to cart button is clicked, add/increment the item
    $('.cart').click(function() {
        var idstr = this.id.toString();
        if (cat_cart[idstr] != undefined) {
            qty = cat_cart[idstr][0] + 1;
            cat_cart[idstr][0] = qty;
        } else {
            qty = 1;
            name = document.getElementById('name' + idstr).innerHTML;
            price = document.getElementById('price' + idstr).innerHTML;
            cat_cart[idstr] = [qty, name, parseInt(price)];
        }
        console.log(cat_cart);
        updateCart(cat_cart);

    });


    function updateCart(cat_cart) {
        if ({{ allProdid | safe }}.length == 0)
            temp_cart = [];
        else
            temp_cart = {{ allProdid | safe }};
        console.log(cat_cart);
        let sum = 0;
        // console.log("temp_cart",temp_cart);
        for (var item of temp_cart) {
          if(item in cat_cart){
            console.log(typeof(item));
            document.getElementById("div" + item).innerHTML = "<button id='minus" + item + "' class='btn btn-primary minus'>-</button> <span id='val" + item + "''>" +
                cat_cart[item][0] + "</span> <button id='plus" + item + "' class= 'btn btn-primary plus'> + </button>";
          } 
        }
        for (var item in cat_cart) {
            sum += cat_cart[item][0];
        }
        localStorage.setItem('cat_cart', JSON.stringify(cat_cart));
        document.getElementById('cart').innerHTML = sum;
        // document.getElementById('cart').innerHTML = Object.keys(cat_cart).length;
    }
    // If plus or minus button is clicked, then change the cart as well as the display value
    $('.divpr').on("click", "button.minus", function() {
        a = this.id.slice(7, );
        if (cat_cart['pr' + a][0] > 0) {
            cat_cart['pr' + a][0] -= 1;
        }
        if (cat_cart['pr' + a][0] == 0) {
            document.getElementById('divpr' + a).innerHTML = '<button id="pr' + a + '" class ="btn btn-primary cart">Add to Cart</button>';
            delete cat_cart['pr' + a];
        } else {
            document.getElementById('valpr' + a).innerHTML = cat_cart['pr' + a][0];
        }
        updateCart(cat_cart);
    });
    $('.divpr').on("click", "button.plus", function() {
        a = this.id.slice(6, );
        cat_cart['pr' + a][0] += 1;
        document.getElementById('valpr' + a).innerHTML = cat_cart['pr' + a][0];
        updateCart(cat_cart);
    });
}
</script>
{% endblock %}